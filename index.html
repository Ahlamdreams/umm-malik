<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>بوصلة التميز الإشرافي - تعلم واختبر معرفتك</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ====== تنسيقات عامة (مختصرة) ====== */
    *{box-sizing:border-box} body{font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2,#f093fb,#f5576c,#4facfe);background-size:400% 400%;animation:gradientShift 15s ease infinite}
    @keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
    .container{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:25px;box-shadow:0 20px 60px rgba(0,0,0,.2);padding:30px;max-width:1200px;width:95%;position:relative}
    h1{font-size:2.2rem;margin:0 0 10px;background:linear-gradient(135deg,#667eea,#764ba2,#f093fb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800}
    .subtitle{color:#4a5568;margin-top:6px}
    .btn{background:linear-gradient(135deg,#667eea,#764ba2,#f093fb);color:#fff;border:0;padding:12px 24px;border-radius:50px;font-weight:700;cursor:pointer;margin:6px}
    .btn.secondary{background:linear-gradient(135deg,#74b9ff,#0984e3)}
    .btn.success{background:linear-gradient(135deg,#00b894,#00cec9)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .screen{display:none;animation:fadeIn .4s ease} .screen.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
    .journey-steps{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:20px}
    .step-card{background:#fff;border:2px solid #eee;border-radius:16px;padding:20px}
    .domains-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .domain-card{background:#fff;border:2px solid #e9ecef;border-radius:16px;padding:22px;cursor:pointer}
    .progress-indicator{height:8px;background:#eee;border-radius:10px;margin-top:10px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,#00b894,#00cec9);width:0}
    .requirement-notice{background:linear-gradient(135deg,#fd79a8,#fdcb6e);color:#fff;border-radius:12px;padding:12px;margin:12px 0}
    .quiz-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:16px;padding:20px;margin-bottom:16px}
    .quiz-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px}
    .quiz-question{background:#fff;border-radius:12px;border-right:5px solid #667eea;padding:18px;margin-bottom:12px}
    .quiz-options{display:grid;gap:10px}
    .quiz-option{background:#fff;border:2px solid #e9ecef;border-radius:12px;padding:14px;cursor:pointer;position:relative}
    .quiz-option.selected{border-color:#667eea;background:#f3f4ff}
    .quiz-option.correct{border-color:#00b894;background:#eafff8}
    .quiz-option.incorrect{border-color:#e17055;background:#fff1f1}
    .leaderboard-content table{border-collapse:collapse;width:100%}
    .leaderboard-content th,.leaderboard-content td{border:1px solid #eee;padding:10px;text-align:center}
    .leaderboard-content th{background:#f0f4ff}
    .rank-1 td{background:#fff3cd!important;font-weight:700;color:#856404}
    .rank-2 td{background:#e2e6ea!important;font-weight:700;color:#495057}
    .rank-3 td{background:#f7e0d3!important;font-weight:700;color:#583c27}
    @media(max-width:768px){.container{padding:18px}}
  </style>
</head>
<body>
  <div class="container">
    <!-- شاشة الترحيب -->
    <div class="screen active" id="welcomeScreen">
      <div class="welcome-screen" style="text-align:center">
        <div style="font-size:4rem;margin-bottom:10px">🎓</div>
        <h1>بوصلة التميز الإشرافي</h1>
        <p class="subtitle">
          رحلة تعليمية تفاعلية لإتقان معايير التقييم التربوي<br>
          <span style="font-size:.9rem;color:#667eea;font-weight:700">فكرة وإعداد: أ. أحلام بنت علي الحمدانية</span>
        </p>
        <div class="journey-steps">
          <div class="step-card"><div style="font-weight:800;margin-bottom:6px">📚 تعلم المجالات</div><div>استكشف المجالات الخمسة وتعرف على معاييرها بالتفصيل</div></div>
          <div class="step-card"><div style="font-weight:800;margin-bottom:6px">🎯 اختبر معرفتك</div><div>اختبار شامل مع تتبع الوقت والدقة</div></div>
          <div class="step-card"><div style="font-weight:800;margin-bottom:6px">🏆 تنافس وتطور</div><div>قارن أداءك مع الآخرين في لوحة الصدارة</div></div>
        </div>
        <div style="margin-top:20px">
          <button class="btn success" onclick="startLearningJourney()">ابدأ رحلة التعلم</button>
          <button class="btn secondary" onclick="showLeaderboard()">لوحة الصدارة</button>
        </div>
      </div>
    </div>

    <!-- شاشة الاسم -->
    <div class="screen" id="nameScreen">
      <h2>مرحباً بك 👋</h2>
      <p class="subtitle">اختر اسمك أو أدخل اسماً جديداً</p>
      <div style="max-width:420px;margin:0 auto;text-align:right">
        <select id="userSelect" style="width:100%;padding:12px;border:2px solid #e9ecef;border-radius:12px;margin-bottom:12px" onchange="handleUserSelection()">
          <option value="">-- اختر من القائمة --</option>
          <option value="عائشة السعيدية">عائشة السعيدية</option>
          <option value="أسماء الجابرية">أسماء الجابرية</option>
          <option value="مريم ال عبدالسلام">مريم ال عبدالسلام</option>
          <option value="رويدا الشيزاوية">رويدا الشيزاوية</option>
          <option value="custom">إدخال اسم جديد</option>
        </select>
        <div id="customNameGroup" style="display:none;margin-bottom:12px">
          <input id="customNameInput" type="text" placeholder="اكتب اسمك هنا..." style="width:100%;padding:12px;border:2px solid #e9ecef;border-radius:12px">
        </div>
        <button class="btn" onclick="confirmName()">متابعة</button>
      </div>
    </div>

    <!-- شاشة المجالات -->
    <div class="screen" id="domainsScreen">
      <h2>المجالات الخمسة للزيارة الإشرافية</h2>
      <p class="subtitle">يجب الاطلاع على جميع المجالات قبل البدء في الاختبار</p>
      <div id="requirementNotice" class="requirement-notice" style="display:none">⚠️ يجب الاطلاع على جميع المجالات الخمسة قبل البدء في الاختبار</div>
      <div class="domains-grid">
        <div class="domain-card" id="domain-1" onclick="showDomainDetails(1)">
          <div style="font-weight:800;margin-bottom:6px">الإنجاز الدراسي</div>
          <div>تقييم مستوى تحصيل الطلبة وتقدمهم الأكاديمي</div>
          <div class="progress-indicator"><div id="progress-1" class="progress-bar"></div></div>
        </div>
        <div class="domain-card" id="domain-2" onclick="showDomainDetails(2)">
          <div style="font-weight:800;margin-bottom:6px">النمو الشخصي</div>
          <div>تطوير شخصية الطلبة وقيمهم وسلوكياتهم</div>
          <div class="progress-indicator"><div id="progress-2" class="progress-bar"></div></div>
        </div>
        <div class="domain-card" id="domain-3" onclick="showDomainDetails(3)">
          <div style="font-weight:800;margin-bottom:6px">مناخ المدرسة وبيئة التعلم</div>
          <div>جودة البيئة التعليمية وتخطيط المنهاج</div>
          <div class="progress-indicator"><div id="progress-3" class="progress-bar"></div></div>
        </div>
        <div class="domain-card" id="domain-4" onclick="showDomainDetails(4)">
          <div style="font-weight:800;margin-bottom:6px">التدريس والتقويم</div>
          <div>فعالية الممارسات التدريسية وأساليب التقويم</div>
          <div class="progress-indicator"><div id="progress-4" class="progress-bar"></div></div>
        </div>
        <div class="domain-card" id="domain-5" onclick="showDomainDetails(5)">
          <div style="font-weight:800;margin-bottom:6px">القيادة والإدارة والحوكمة</div>
          <div>قيادة التغيير وتطبيق السياسات والمبادرات</div>
          <div class="progress-indicator"><div id="progress-5" class="progress-bar"></div></div>
        </div>
      </div>
      <div style="margin-top:20px">
        <button class="btn secondary" onclick="showWelcomeScreen()">الصفحة الرئيسية</button>
        <button class="btn success" id="startQuizBtn" onclick="startQuiz()" disabled>ابدأ الاختبار الآن!</button>
      </div>
    </div>

    <!-- تفاصيل مجال -->
    <div class="screen" id="domainDetailsScreen">
      <div id="domainDetailsContent"></div>
    </div>

    <!-- شاشة الاختبار -->
    <div class="screen" id="quizScreen">
      <div class="quiz-header">
        <h3>🎯 اختبار بوصلة التميز الإشرافي</h3>
        <div class="quiz-stats">
          <div><div id="currentQuestionNum" style="font-weight:800;font-size:1.4rem">1</div><div>السؤال الحالي</div></div>
          <div><div id="totalQuestions" style="font-weight:800;font-size:1.4rem">20</div><div>إجمالي الأسئلة</div></div>
          <div><div id="currentScore" style="font-weight:800;font-size:1.4rem">0</div><div>النقاط</div></div>
          <div><div id="timeRemaining" style="font-weight:800;font-size:1.4rem">03:00</div><div>الوقت المتبقي</div></div>
        </div>
        <div style="background:rgba(255,255,255,.25);height:10px;border-radius:10px;overflow:hidden;margin-top:10px">
          <div id="quizProgressBar" style="height:100%;width:0;background:linear-gradient(90deg,#00cec9,#55efc4)"></div>
        </div>
      </div>
      <div id="quizContent"></div>
    </div>

    <!-- شاشة النتائج -->
    <div class="screen" id="resultsScreen">
      <div class="results-container" id="resultsContent" style="text-align:center"></div>
    </div>

    <!-- لوحة الصدارة -->
    <div class="screen" id="leaderboardScreen">
      <h2>🏆 لوحة الصدارة</h2>
      <p class="subtitle">أفضل الإنجازات في بوصلة التميز الإشرافي</p>
      <div class="leaderboard-tabs" style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
        <button class="btn" onclick="showLeaderboardFromSheets('bestScore')">🎯 الدقة</button>
        <button class="btn secondary" onclick="showLeaderboardFromSheets('bestTime')">⚡ السرعة</button>
      </div>
      <div class="leaderboard-content" id="leaderboardContent">
        <table>
          <thead>
            <tr>
              <th>الترتيب</th><th>الاسم</th><th>الدقة (%)</th><th>الوقت</th><th>المحاولات</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"><tr><td colspan="5">جاري التحميل...</td></tr></tbody>
        </table>
      </div>
      <div style="margin-top:16px">
        <button class="btn secondary" onclick="showWelcomeScreen()">الصفحة الرئيسية</button>
        <button class="btn" onclick="startQuiz()">اختبار جديد</button>
      </div>
    </div>
  </div>

  <script>
    /* ============ إعداد رابط Apps Script (تعريف واحد فقط) ============ */
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyJT7X0M7YOck1nKiaZv54CFAuK44cr85Mcv5Besvv1xlJ9OoWT0BJHpHnDOLw2rM7/exec';

    /* ============ بيانات المجالات والأسئلة (من نسختك) ============ */
    const domains = {
      1:{title:"الإنجاز الدراسي",icon:"📊",description:"الأساليب المنفذة ...",criteria:[
        {id:1,title:"التحصيل الدراسي",explanation:"مستوى تحصيل الطلبة ...",examples:[
          "في درس الكسور: جميع الطلبة نجحوا ...","في درس التمثيل الضوئي ...","في اختبار اللغة العربية ...","مشروع 'تراثنا العماني' ...",
          "في درس الأنظمة البيئية ...","تفوق الطلبة في الاختبارات ...","إتقان الطلبة للمهارات ...","تطبيق الطلبة للمفاهيم ...",
          "قدرة الطلبة على تلخيص ...","استخدام الطلبة للمصطلحات ...","إظهار الطلبة لمستوى عالٍ ...","تميز الطلبة في حل المسائل ...",
          "قدرة الطلبة على تفسير النتائج ...","إظهار الطلبة لمهارات التفكير ...","تطبيق الطلبة للمعرفة ...","قدرة الطلبة على إنتاج أعمال ...",
          "استخدام الطلبة لاستراتيجيات ...","إظهار الطلبة لقدرة على التعلم الذاتي ...","تطبيق الطلبة لمهارات البحث ...","قدرة الطلبة على تقييم مصادر ..."
        ]}
      ]},
      2:{title:"النمو الشخصي",icon:"🌱",description:"تعزيز العلاقات ...",criteria:[
        {id:4,title:"القيم والسلوك",explanation:"تمسك الطلبة بالهوية ...",examples:[
          "في اليوم الوطني: ...","طالب هندي ساعد زميله ...","عند سماع النشيد الوطني ...","طالبة من جنسية أخرى ...","في الاختبار: طالب وجد ...",
          "إظهار روح المسؤولية ...","التعبير عن الآراء بأدب ...","المشاركة الإيجابية ...","إظهار قيم التسامح ...","الاعتزاز الواضح بالتراث ...",
          "تطبيق قيم العمل الجماعي ...","إظهار الاحترام العميق ...","التمسك الثابت بالقيم ...","إظهار قيم الإيثار ...","تطبيق مبادئ الحوار ...",
          "إظهار قيم الصبر ...","تطبيق قيم النزاهة ...","إظهار روح القيادة ...","تطبيق قيم احترام البيئة ...","إظهار قيم التواضع ..."
        ]}
      ]},
      3:{title:"مناخ المدرسة وبيئة التعلم",icon:"🏫",description:"الإطار الشامل ...",criteria:[
        {id:5,title:"جودة بيئة التعلم",explanation:"متابعة جوانب الأمن ...",examples:[
          "يتابع المعلم جوانب الأمن ...","توفير بيئة تعليمية آمنة ...","تنظيم الصف والمواد ...","ضمان توفر الإضاءة ...","تطبيق إجراءات السلامة ...",
          "المحافظة على نظافة ...","توفير مساحات مناسبة ...","استخدام الألوان والديكورات ...","توفير بيئة هادئة ...","ضمان سهولة الوصول ...",
          "تطبيق معايير الصحة ...","توفير بيئة تعليمية شاملة ...","تهيئة مناخ صفي إيجابي ...","توفير أثاث مدرسي مناسب ...","ضمان توفر التقنيات ...",
          "تطبيق معايير النظافة ...","توفير مساحات للعرض ...","ضمان توفر مصادر التعلم ...","تطبيق إجراءات الطوارئ ...","توفير بيئة تحترم الخصوصية ..."
        ]},
        {id:6,title:"تخطيط المنهاج الدراسي",explanation:"تخطيط المنهاج ...",examples:[
          "يخطط المعلم المنهاج ...","التوافق التام بين التخطيط ...","ربط واضح ومحكم ...","تحديد أهداف تعليمية ...","تنويع الاستراتيجيات ...",
          "تخطيط الأنشطة التعليمية ...","مراعاة التسلسل المنطقي ...","تخطيط أساليب التقويم ...","تحديد المصادر والوسائل ...","مراعاة الفروق الفردية ...",
          "ربط المحتوى التعليمي ...","تخطيط الأنشطة الإثرائية ..."
        ]}
      ]},
      4:{title:"التدريس والتقويم",icon:"🎓",description:"الإجراءات التدريسية ...",criteria:[
        {id:7,title:"إدارة الصف",explanation:"فاعلية الإدارة الصفية ...",examples:[
          "يدير المعلم الصف بفاعلية ...","استغلال أمثل لوقت التعلم ...","تطبيق استراتيجيات متنوعة ...","إنشاء بيئة صفية منظمة ...",
          "استخدام تقنيات فعالة ...","تطبيق قواعد صفية واضحة ...","التعامل مع السلوكيات ...","توزيع الأدوار ...","استخدام أساليب التعزيز ...",
          "إدارة الانتقالات ...","تنظيم المجموعات ..."
        ]},
        {id:8,title:"فاعلية التدريس",explanation:"توظيف استراتيجيات التدريس ...",examples:[
          "يوظف المعلم استراتيجيات ...","تنويع الاستراتيجيات ...","ربط فعال بالمحتوى ...","استخدام التعلم النشط ...","التعلم القائم على حل المشكلات ...",
          "استخدام القصص ...","التعلم التعاوني ...","العصف الذهني ...","التفكير الناقد ...","المحاكاة والألعاب ...","التعلم المتمايز ...","التقويم التكويني ..."
        ]},
        {id:9,title:"تفعيل المصادر والموارد التعليمية",explanation:"تفعيل التقنيات الرقمية ...",examples:[
          "يفعل المعلم التقنيات ...","الاستخدام الإبداعي للتقنيات ...","توظيف الذكاء الاصطناعي ...","السبورات التفاعلية ...","المختبرات ...",
          "الفيديوهات التعليمية ...","المكتبة الرقمية ...","تطبيقات الهواتف ...","الواقع المعزز ...","منصات التعلم الإلكتروني ...","أدوات التقييم الرقمي ...","المصادر المجتمعية ..."
        ]},
        {id:10,title:"التقويم ومساندة التقدم",explanation:"توظيف أساليب تقويم ...",examples:[
          "يوظف المعلم أساليب تقويم ...","تغذية راجعة فورية ...","استخدام نتائج التقويم ...","التقويم التشخيصي ...","التقويم التكويني ...","التقويم الختامي ...",
          "ملفات الإنجاز ...","التقويم الذاتي والأقران ...","التقويم الأدائي ...","التقويم القائم على المشاريع ...","أدوات التقويم الرقمية ...","خطط علاجية وإثرائية ..."
        ]}
      ]},
      5:{title:"القيادة والإدارة والحوكمة",icon:"👑",description:"المشاركات والأنشطة المهنية ...",criteria:[
        {id:11,title:"قيادة التغيير",explanation:"توظيف التقويم الذاتي ...",examples:[
          "المعلم يجري تقويماً ...","المشاركة الفاعلة في ورش ...","تطبيق ما تم تعلمه ...","بحوث إجرائية ...","تبادل الخبرات ...","قيادة مجتمعات التعلم ...","تطوير أدوات تعليمية ...",
          "تطبيق اتجاهات حديثة ...","استشارة المعلمين الجدد ...","لجان التطوير ...","مهارات القيادة ...","التعلم مدى الحياة ..."
        ]},
        {id:12,title:"الحوكمة",explanation:"تطبيق السياسات والأنظمة ...",examples:[
          "المعلم يطبق السياسات ...","الالتزام بالمعايير ...","إجراءات التقويم والتوثيق ...","الالتزام بالمواعيد ...","سياسات الأمن والسلامة ...",
          "أخلاقيات المهنة ...","حماية الطلبة ...","سرية المعلومات ...","سياسات التقويم والامتحانات ...","التطوير المهني المطلوب ...","معايير الجودة ...","الشفافية والمساءلة ..."
        ]},
        {id:13,title:"تنفيذ مبادرات وأنشطة تربوية",explanation:"تنفيذ مبادرات وأنشطة ...",examples:[
          "تقديم مبادرات فعالة ...","التفاعل الإيجابي ...","قيادة مشاريع تطويرية ...","تنظيم فعاليات تعليمية ...","الأنشطة اللاصفية ...",
          "برامج إرشادية ...","خدمة المجتمع ...","رحلات تعليمية ...","معارض ومسابقات ...","شراكات مجتمعية ...","برامج توعوية ...","الاستدامة والبيئة ..."
        ]}
      ]}
    };

    const quizQuestions = [
      {question:"في حصة رياضيات عن الكسور ...",options:["التحصيل الدراسي","فاعلية التدريس","تفعيل المصادر والموارد التعليمية","إدارة الصف"],correct:0,explanation:"نجاح جميع الطلبة ..."},
      {question:"معلمة لغة عربية في درس 'الوصف' ...",options:["التحصيل الدراسي","التقدم الدراسي","مهارات التعلم","القيم والسلوك"],correct:1,explanation:"التحسن الواضح ..."},
      {question:"معلم علوم استخدم الواقع المعزز ...",options:["استخدام التقنية فقط","تفاعل الطلبة ...","ربط الدرس بالحياة","استخدام الهاتف"],correct:1,explanation:"للحصول على تقدير متميز ..."},
      {question:"في حصة تاريخ ...",options:["متميز","جيد","ملائم","غير ملائم"],correct:0,explanation:"أسلوب متميز في إدارة الصف ..."},
      {question:"التسامح والهوية ...",options:["التحصيل فقط","القيم والسلوك","فاعلية التدريس","مهارات التعلم"],correct:1,explanation:"مثال متميز على القيم والسلوك ..."},
      {question:"تقويم متنوع وتغذية راجعة ...",options:["إدارة الصف","التقويم ومساندة التقدم","فاعلية التدريس","تخطيط المنهاج"],correct:1,explanation:"يشمل تشخيصي وتكويني ..."},
      {question:"قيادة التغيير ...",options:["فاعلية التدريس","قيادة التغيير","التقويم","مبادرات"],correct:1,explanation:"تقويم ذاتي وتطبيق ومشاركة ..."},
      {question:"تخطيط وحدة الماء ...",options:["جيد","متميز","ملائم","غير ملائم"],correct:1,explanation:"تكامل وأهداف واضحة ..."},
      {question:"عدد نادر يكتسب المهارات ...",options:["متميز (1)","جيد (2)","ملائم (3)","يحتاج تدخل (5)"],correct:3,explanation:"يحتاج تدخل عاجل ..."},
      {question:"أي مجال لتحصيل الطلبة؟",options:["الإنجاز الدراسي","النمو الشخصي","التدريس والتقويم","القيادة"],correct:0,explanation:"يركز على التحصيل والتقدم ..."},
      {question:"جميع الطلبة يتجاوزون النواتج ...",options:["متميز (1)","جيد (2)","ملائم (3)","غير ملائم (4)"],correct:0,explanation:"أداء متميز ..."},
      {question:"القيم والسلوك يتبع ...",options:["الإنجاز","النمو الشخصي","مناخ المدرسة","التدريس"],correct:1,explanation:"يتبع النمو الشخصي ..."},
      {question:"مبادرة 'مدرستي صحية' ...",options:["جيد","متميز","ملائم","غير ملائم"],correct:1,explanation:"شامل ومؤثر ومشاركة واسعة ..."},
      {question:"التصحر ومهارات بحث ...",options:["التحصيل","مهارات التعلم","فاعلية التدريس","تفعيل المصادر"],correct:1,explanation:"تفكير نقدي ورقمي ..."},
      {question:"مختبر كيمياء وسلامة ...",options:["جيد","متميز","ملائم","غير ملائم"],correct:1,explanation:"بيئة تعلم آمنة ومحفزة ..."},
      {question:"حوكمة وأخلاقيات ...",options:["قيادة التغيير","الحوكمة","مبادرات","إدارة الصف"],correct:1,explanation:"تطبيق السياسات والأنظمة ..."},
      {question:"حوالي نصف الطلبة يحققون النواتج ...",options:["جيد (2)","ملائم (3)","غير ملائم (4)","يحتاج تدخل (5)"],correct:1,explanation:"أداء ملائم ..."},
      {question:"أي مجال يضم قيادة التغيير؟",options:["التدريس","مناخ المدرسة","القيادة والإدارة والحوكمة","النمو الشخصي"],correct:2,explanation:"يضم القيادة والحوكمة والمبادرات ..."},
      {question:"مهارات التعلم تتبع ...",options:["الإنجاز الدراسي","النمو الشخصي","التدريس","مناخ المدرسة"],correct:0,explanation:"ضمن الإنجاز الدراسي ..."},
      {question:"جودة بيئة التعلم تتبع ...",options:["الإنجاز","النمو","مناخ المدرسة","التدريس"],correct:2,explanation:"ضمن مناخ المدرسة ..."},
      {question:"التقويم ومساندة التقدم تتبع ...",options:["الإنجاز","التدريس والتقويم","مناخ","القيادة"],correct:1,explanation:"ضمن التدريس والتقويم ..."},
      {question:"المبادرات التربوية تتبع ...",options:["النمو","المناخ","التدريس","القيادة"],correct:3,explanation:"ضمن القيادة والإدارة ..."},
      {question:"تفعيل التقنيات والمختبرات ...",options:["فاعلية التدريس","تفعيل المصادر والموارد التعليمية","إدارة الصف","التقويم"],correct:1,explanation:"هذا هو المعيار ..."},
      {question:"احترام متبادل وهوية ...",options:["الإنجاز","النمو الشخصي","التدريس","القيادة"],correct:1,explanation:"النمو الشخصي ..."},
      {question:"تقويم ذاتي وتطوير مهني ...",options:["قيادة التغيير","الحوكمة","مبادرات","فاعلية التدريس"],correct:0,explanation:"قيادة التغيير ..."},
      {question:"مشاركة فعالة وحلول إبداعية ...",options:["متميز (1)","جيد (2)","ملائم (3)","غير ملائم (4)"],correct:0,explanation:"متميز ..."},
      {question:"تطبيق السياسات والأنظمة ...",options:["قيادة التغيير","الحوكمة","مبادرات","إدارة الصف"],correct:1,explanation:"حوكمة ..."},
      {question:"تعلم نشط ومشكلات ...",options:["إدارة الصف","فاعلية التدريس","تفعيل المصادر","التقويم"],correct:1,explanation:"فاعلية التدريس ..."},
      {question:"تقويم متنوع يراعي التمايز ...",options:["متميز (1)","جيد (2)","ملائم (3)","غير ملائم (4)"],correct:0,explanation:"متميز ..."},
      {question:"قواعد صفية وتوزيع أدوار ...",options:["إدارة الصف","فاعلية التدريس","جودة البيئة","التقويم"],correct:0,explanation:"إدارة الصف ..."},
      {question:"قيادة مجتمعات التعلم وبحوث ...",options:["قيادة التغيير","الحوكمة","مبادرات","فاعلية"],correct:0,explanation:"قيادة التغيير ..."},
      {question:"إدارة صف متوسطة ...",options:["جيد (2)","ملائم (3)","غير ملائم (4)","يحتاج تدخل (5)"],correct:1,explanation:"ملائم ..."},
      {question:"تنظيم فعاليات ومشاريع مجتمعية ...",options:["قيادة","حوكمة","مبادرات","فاعلية"],correct:2,explanation:"مبادرات ..."},
      {question:"تفكير نقدي وتقنيات رقمية ...",options:["التحصيل","التقدم","مهارات التعلم","القيم"],correct:2,explanation:"مهارات التعلم ..."},
      {question:"تفعيل التقنيات محدود ...",options:["ملائم (3)","غير ملائم (4)","يحتاج تدخل (5)","جيد (2)"],correct:1,explanation:"غير ملائم ..."},
      {question:"قصص واقعية وربط بالحياة ...",options:["إدارة الصف","فاعلية التدريس","تفعيل المصادر","التقويم"],correct:1,explanation:"فاعلية التدريس ..."},
      {question:"تغذية راجعة واستخدام نتائج ...",options:["فاعلية التدريس","إدارة الصف","التقويم ومساندة التقدم","تفعيل المصادر"],correct:2,explanation:"التقويم ومساندة التقدم ..."
      }
    ];

    /* ============ متغيرات الحالة ============ */
    let currentUser = localStorage.getItem('currentUser') || '';
    let currentQuizQuestion = 0;
    let quizScore = 0;
    let selectedQuestions = [];
    let totalQuizQuestions = 20;
    let quizStartTime = 0;
    let quizTimer = null;
    let viewedDomains = new Set();
    let quizTimeLimit = 180; // 3 دقائق
    let remainingTime = 180;

    /* ============ أدوات مساعدة ============ */
    function formatSeconds(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }
    function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id)?.classList.add('active'); }

    /* ============ إدارة الشاشات ============ */
    function showWelcomeScreen(){ stopQuizTimer(); showScreen('welcomeScreen'); }
    function startLearningJourney(){ showScreen('nameScreen'); }
    function showDomainsScreen(){ updateDomainProgress(); showScreen('domainsScreen'); }
    function showLeaderboard(){ showLeaderboardFromSheets('bestScore'); }

    /* ============ اختيار/تأكيد الاسم ============ */
    function handleUserSelection(){
      const select=document.getElementById('userSelect');
      const group=document.getElementById('customNameGroup');
      group.style.display = (select.value==='custom')?'block':'none';
      if(select.value==='custom') document.getElementById('customNameInput').focus();
    }
    function confirmName(){
      const select=document.getElementById('userSelect');
      const custom=document.getElementById('customNameInput');
      if(select.value==='custom'){
        currentUser = (custom.value||'').trim();
        if(!currentUser){ alert('يرجى إدخال اسمك أولاً'); return; }
      } else if(select.value){
        currentUser = select.value;
      } else { alert('يرجى اختيار اسم أو إدخال اسم جديد'); return; }
      localStorage.setItem('currentUser', currentUser);
      showDomainsScreen();
    }

    /* ============ تقدم المجالات وزر الاختبار ============ */
    function updateDomainProgress(){
      for(let i=1;i<=5;i++){
        const pb=document.getElementById(`progress-${i}`);
        const card=document.getElementById(`domain-${i}`);
        if(pb&&card){
          const done=viewedDomains.has(i);
          pb.style.width = done ? '100%' : '0%';
          if(done && !card.querySelector('.completion-badge')){
            const b=document.createElement('div'); b.className='completion-badge'; b.textContent='✓ مكتمل';
            b.style.cssText='position:absolute;top:10px;left:10px;background:#00b894;color:#fff;padding:4px 10px;border-radius:12px;font-weight:700';
            card.style.position='relative'; card.appendChild(b);
          }
        }
      }
      const btn=document.getElementById('startQuizBtn');
      const note=document.getElementById('requirementNotice');
      const allViewed = viewedDomains.size===5;
      btn.disabled=!allViewed; note.style.display = allViewed ? 'none' : 'block';
    }

    /* ============ تفاصيل المجال ============ */
    function showDomainDetails(domainId){
      const d=domains[domainId]; if(!d) return;
      viewedDomains.add(domainId); updateDomainProgress();

      const totalCriteria=d.criteria.length;
      const totalExamples=d.criteria.reduce((s,c)=>s+c.examples.length,0);

      const criteriaIcons={1:'📊',2:'📈',3:'🎯',4:'🌱',5:'🏫',6:'📋',7:'👨‍🏫',8:'🎓',9:'💻',10:'📝',11:'👑',12:'⚖️',13:'🚀'};
      let criteriaHTML='';
      d.criteria.forEach(cr=>{
        const third=Math.ceil(cr.examples.length/3);
        const practical=cr.examples.slice(0,third);
        const excellent=cr.examples.slice(third,third*2);
        const innovative=cr.examples.slice(third*2);

        const exHTML=(arr,label,color,icon)=>arr.map(e=>`
          <div class="example-item" style="background:#f8fff9;border:2px solid ${color};border-radius:12px;padding:12px">
            <div class="example-category" style="display:inline-block;background:${color};color:#fff;padding:2px 10px;border-radius:16px;margin-bottom:6px">${label}</div>
            <span style="margin:0 6px">${icon}</span>${e}
          </div>`).join('');

        criteriaHTML+=`
          <div class="criterion-card" style="background:#fff;border:2px solid #e9ecef;border-radius:16px;padding:18px;margin-bottom:14px">
            <div class="criterion-header" style="display:flex;align-items:center;gap:10px;border-bottom:2px solid #f5f7ff;padding-bottom:10px;margin-bottom:10px">
              <div class="criterion-icon" style="font-size:1.4rem">${criteriaIcons[cr.id]||'⭐'}</div>
              <div class="criterion-title" style="font-weight:800">${cr.title}</div>
              <div class="criterion-number" style="margin-inline-start:auto;background:#eef2ff;color:#667eea;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800">${cr.id}</div>
            </div>
            <div class="criterion-explanation" style="background:#f8f9ff;border-right:5px solid #667eea;border-radius:12px;padding:12px;margin-bottom:10px">${cr.explanation}</div>

            <div class="examples-section">
              <div class="interactive-tabs" style="display:flex;gap:6px;background:#f8f9fa;border-radius:12px;padding:6px;margin-bottom:8px">
                <button class="btn" style="padding:8px 12px" onclick="switchTab(${cr.id},'practical',event)">🎯 أمثلة عملية</button>
                <button class="btn success" style="padding:8px 12px" onclick="switchTab(${cr.id},'excellent',event)">⭐ أمثلة متميزة</button>
                <button class="btn secondary" style="padding:8px 12px" onclick="switchTab(${cr.id},'innovative',event)">🚀 أمثلة إبداعية</button>
              </div>
              <div id="tab-${cr.id}-practical" class="tab-content active">
                <div class="examples-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">
                  ${exHTML(practical,'عملي','#2196F3','✅')}
                </div>
              </div>
              <div id="tab-${cr.id}-excellent" class="tab-content" style="display:none">
                <div class="examples-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">
                  ${exHTML(excellent,'متميز','#00b894','🌟')}
                </div>
              </div>
              <div id="tab-${cr.id}-innovative" class="tab-content" style="display:none">
                <div class="examples-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">
                  ${exHTML(innovative,'إبداعي','#FF9800','💡')}
                </div>
              </div>
            </div>
          </div>
        `;
      });

      document.getElementById('domainDetailsContent').innerHTML=`
        <div class="domain-detail-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:18px;padding:18px;margin-bottom:14px">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div>
              <div style="font-size:3rem">${d.icon}</div>
              <h3 style="margin:6px 0">${d.title}</h3>
            </div>
            <div class="domain-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
              <div style="text-align:center"><div style="font-weight:800;font-size:1.2rem">${totalCriteria}</div><div>معايير</div></div>
              <div style="text-align:center"><div style="font-weight:800;font-size:1.2rem">${totalExamples}</div><div>أمثلة</div></div>
              <div style="text-align:center"><div style="font-weight:800;font-size:1.2rem">${Math.ceil(totalExamples/10)}</div><div>دقائق</div></div>
            </div>
          </div>
          <p style="margin:8px 0 0">${d.description}</p>
        </div>
        <div>${criteriaHTML}</div>
        <div style="text-align:center;margin-top:16px">
          <button class="btn secondary" onclick="showDomainsScreen()">🔙 العودة للمجالات</button>
          <button class="btn success" onclick="checkAndStartQuiz()">🚀 ابدأ الاختبار الآن</button>
        </div>
      `;
      showScreen('domainDetailsScreen');
    }

    function switchTab(criterionId, tabType, event){
      ['practical','excellent','innovative'].forEach(t=>{
        const el=document.getElementById(`tab-${criterionId}-${t}`);
        if(el) el.style.display = (t===tabType)?'block':'none';
      });
    }

    /* ============ بدء الاختبار ============ */
    function checkAndStartQuiz(){
      if(viewedDomains.size<5){ alert('يجب الاطلاع على جميع المجالات الخمسة أولاً'); return; }
      startQuiz();
    }

    function startQuiz(){
      if(viewedDomains.size<5){ alert('يجب الاطلاع على جميع المجالات الخمسة أولاً'); return; }
      // اختيار عشوائي 20 سؤال
      const shuffled=[...quizQuestions].sort(()=>Math.random()-0.5);
      selectedQuestions=shuffled.slice(0,totalQuizQuestions);
      currentQuizQuestion=0;
      quizScore=0;
      remainingTime=quizTimeLimit;
      document.getElementById('totalQuestions').textContent = selectedQuestions.length;
      document.getElementById('currentScore').textContent = quizScore;
      document.getElementById('quizProgressBar').style.width='0%';
      renderQuestion();
      startQuizTimer();
      showScreen('quizScreen');
    }

    function renderQuestion(){
      const q=selectedQuestions[currentQuizQuestion];
      if(!q){ showQuizResults(); return; }
      document.getElementById('currentQuestionNum').textContent = currentQuizQuestion+1;
      const html=`
        <div class="quiz-question">${q.question}</div>
        <div class="quiz-options">
          ${q.options.map((opt,i)=>`<div class="quiz-option" data-idx="${i}" onclick="selectOption(${i})">${opt}</div>`).join('')}
        </div>
        <div id="explainBox" style="display:none" class="explanation-box"></div>
        <div style="text-align:center;margin-top:8px">
          <button id="nextBtn" class="btn" onclick="nextQuestion()" disabled>التالي</button>
        </div>
      `;
      document.getElementById('quizContent').innerHTML=html;
      const prog=((currentQuizQuestion)/selectedQuestions.length)*100;
      document.getElementById('quizProgressBar').style.width=`${prog}%`;
    }

    function selectOption(index){
      const q=selectedQuestions[currentQuizQuestion];
      const options=[...document.querySelectorAll('.quiz-option')];
      options.forEach(o=>o.classList.remove('selected','correct','incorrect'));
      options[index].classList.add('selected');
      const correctIndex=q.correct;
      if(index===correctIndex){ options[index].classList.add('correct'); quizScore++; }
      else { options[index].classList.add('incorrect'); options[correctIndex]?.classList.add('correct'); }
      document.getElementById('currentScore').textContent = quizScore;
      const ex=document.getElementById('explainBox');
      ex.style.display='block';
      ex.className='explanation-box'+(index===correctIndex?'':' incorrect');
      ex.textContent=q.explanation || '';
      document.getElementById('nextBtn').disabled=false;
      // منع تغيير الاختيار بعد الإجابة
      options.forEach(o=>o.onclick=null);
    }

    function nextQuestion(){
      currentQuizQuestion++;
      if(currentQuizQuestion>=selectedQuestions.length){ showQuizResults(); }
      else { renderQuestion(); }
    }

    function startQuizTimer(){
      stopQuizTimer();
      quizStartTime=Date.now();
      quizTimer=setInterval(()=>{
        remainingTime--;
        document.getElementById('timeRemaining').textContent = formatSeconds(Math.max(0,remainingTime));
        if(remainingTime<=0){ stopQuizTimer(); showQuizResults(); }
      },1000);
    }
    function stopQuizTimer(){ if(quizTimer){ clearInterval(quizTimer); quizTimer=null; } }

    /* ============ حفظ النتيجة إلى Google Sheets ============ */
    async function saveUserScoreToSheets(userName, scorePercentage, totalQuestionsCount, totalTime){
      try{
        if(!APPS_SCRIPT_URL) throw new Error('APPS_SCRIPT_URL غير مهيأ.');
        const params=new URLSearchParams({
          action:'saveScore',
          name:userName||'مشارك',
          bestScore:String(scorePercentage??0),
          bestTime:String(totalTime??0),
          gamesPlayed:'1'
        });
        const res = await fetch(`${APPS_SCRIPT_URL}?${params.toString()}`,{method:'GET',mode:'cors',cache:'no-cache'});
        const text=await res.text();
        let data; try{ data=JSON.parse(text);}catch{ data={}; }
        return { isNewRecord:!!data.isNewRecord, isNewSpeedRecord:!!data.isNewSpeedRecord };
      }catch(e){
        console.error('Failed to save score:',e);
        return { isNewRecord:false, isNewSpeedRecord:false };
      }
    }

    /* ============ عرض النتائج ============ */
    function renderQuizResultsScreen(percentage,totalTime,records){
      const total=selectedQuestions.length;
      let icon='📚',msg='يُنصح بمراجعة المجالات والمعايير مرة أخرى';
      if(percentage>=90){icon='🏆';msg='أداء متميز! لديك فهم عميق';}
      else if(percentage>=80){icon='🥇';msg='أداء ممتاز! فهم جيد جداً';}
      else if(percentage>=70){icon='🥈';msg='أداء جيد! توجد نقاط للتحسين';}
      else if(percentage>=60){icon='🥉';msg='أداء مقبول! راجع بعض المجالات';}
      const recordMsgs=[
        records?.isNewRecord?'<div style="color:#e74c3c;font-weight:800">🎉 رقم قياسي جديد في الدقة!</div>':'',
        records?.isNewSpeedRecord?'<div style="color:#00b894;font-weight:800">⚡ رقم قياسي جديد في السرعة!</div>':''
      ].join('');
      document.getElementById('resultsContent').innerHTML=`
        <div style="font-size:4rem">${icon}</div>
        <h2>انتهى الاختبار!</h2>
        ${recordMsgs}
        <div style="margin:6px 0">${msg}</div>
        <div class="results-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px">
          <div class="result-stat" style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,.05)">
            <div class="result-stat-value" style="font-size:2rem;color:#667eea;font-weight:800">${quizScore}/${total}</div>
            <div class="result-stat-label">الإجابات الصحيحة</div>
          </div>
          <div class="result-stat" style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,.05)">
            <div class="result-stat-value" style="font-size:2rem;color:#667eea;font-weight:800">${percentage}%</div>
            <div class="result-stat-label">نسبة النجاح</div>
          </div>
          <div class="result-stat" style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,.05)">
            <div class="result-stat-value" style="font-size:2rem;color:#667eea;font-weight:800">${formatSeconds(totalTime)}</div>
            <div class="result-stat-label">الوقت المستغرق</div>
          </div>
          <div class="result-stat" style="background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,.05)">
            <div class="result-stat-value" style="font-size:2rem;color:#667eea;font-weight:800">${Math.max(1,Math.round(totalTime/Math.max(1,selectedQuestions.length)))}ث</div>
            <div class="result-stat-label">متوسط الوقت/سؤال</div>
          </div>
        </div>
        <div style="margin-top:16px">
          <button class="btn" onclick="startQuiz()">اختبار جديد</button>
          <button class="btn success" onclick="showLeaderboardFromSheets('bestScore')">لوحة الصدارة</button>
          <button class="btn secondary" onclick="showWelcomeScreen()">الصفحة الرئيسية</button>
        </div>
      `;
      showScreen('resultsScreen');
    }

    async function showQuizResults(){
      stopQuizTimer();
      const totalTime = quizTimeLimit - Math.max(0,remainingTime);
      const percentage = selectedQuestions.length ? Math.round((quizScore/selectedQuestions.length)*100) : 0;
      const records = await saveUserScoreToSheets(currentUser, percentage, selectedQuestions.length, totalTime);
      renderQuizResultsScreen(percentage,totalTime,records);
    }

    /* ============ لوحة الصدارة من Google Sheets ============ */
    async function showLeaderboardFromSheets(orderBy='bestScore'){
      const body=document.getElementById('leaderboardBody');
      body.innerHTML='<tr><td colspan="5">جاري تحميل لوحة الصدارة... 🚀</td></tr>';
      try{
        const res=await fetch(APPS_SCRIPT_URL,{method:'GET',mode:'cors'});
        const text=await res.text(); let data;
        try{ data=JSON.parse(text);}catch{ throw new Error('الرد ليس JSON. تحققي من doGet()'); }
        const users=Array.isArray(data)?data.map(u=>({
          name:u.Name??'', bestScore:Number(u.BestScore)||0, bestTime:Number(u.BestTime)||0, gamesPlayed:Number(u.GamesPlayed)||0
        })):[];
        users.sort((a,b)=>{
          if(orderBy==='bestScore'){ if(b.bestScore!==a.bestScore) return b.bestScore-a.bestScore; return a.bestTime-b.bestTime; }
          const ta=a.bestTime||Infinity, tb=b.bestTime||Infinity; if(ta!==tb) return ta-tb; return b.bestScore-a.bestScore;
        });
        body.innerHTML='';
        if(users.length===0){ body.innerHTML='<tr><td colspan="5">لا توجد نتائج مسجلة حتى الآن.</td></tr>'; }
        else{
          users.slice(0,10).forEach((u,i)=>{
            const cls=i<3?`rank-${i+1}`:''; const time=u.bestTime>0?formatSeconds(u.bestTime):'---';
            const scoreStyle='background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:10px;font-weight:700;padding:4px 8px;display:inline-block;min-width:50px';
            const tr=document.createElement('tr'); tr.className=cls;
            tr.innerHTML=`<td style="font-weight:700">${i+1}</td><td style="text-align:right">${u.name}</td><td><span style="${scoreStyle}">${u.bestScore}%</span></td><td>${time}</td><td>${u.gamesPlayed}</td>`;
            body.appendChild(tr);
          });
        }
        showScreen('leaderboardScreen');
      }catch(e){
        console.error(e);
        body.innerHTML='<tr><td colspan="5" style="color:#e74c3c">حدث خطأ أثناء جلب البيانات. تأكدي من نشر Apps Script كـ Web app وإرجاع JSON.</td></tr>';
        showScreen('leaderboardScreen');
      }
    }

    /* ============ كشف الدوال للأزرار ============ */
    window.startLearningJourney = startLearningJourney;
    window.showLeaderboard = showLeaderboard;
    window.handleUserSelection = handleUserSelection;
    window.confirmName = confirmName;
    window.showDomainsScreen = showDomainsScreen;
    window.showWelcomeScreen = showWelcomeScreen;
    window.showDomainDetails = showDomainDetails;
    window.switchTab = switchTab;
    window.checkAndStartQuiz = checkAndStartQuiz;
    window.startQuiz = startQuiz;
    window.selectOption = selectOption;
    window.nextQuestion = nextQuestion;
    window.showQuizResults = showQuizResults;
    window.showLeaderboardFromSheets = showLeaderboardFromSheets;

    /* ============ تهيئة أولية ============ */
    if(currentUser){ viewedDomains=new Set([1,2,3,4,5]); } // اختياري: لو أردتِ تمكين الاختبار بسرعة أثناء التجربة احذفي هذا السطر
    updateDomainProgress();
  </script>
</body>
</html>
